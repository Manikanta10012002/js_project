<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dev Feed</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    .container { max-width: 800px; margin: auto; }
    .box { background: #fff; padding: 20px; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, textarea { width: 100%; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 8px 16px; margin-right: 10px; cursor: pointer; }
    .post { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 6px; background: #fff; }
    .comment { margin-left: 20px; font-size: 0.9em; color: #444; }
    img { max-width: 100%; margin-top: 10px; border-radius: 5px; }
  </style>
</head>
<body>
<div class="container">
  <div class="box">
    <h2>Create Post</h2>
    <form id="postForm">
      <input id="title" placeholder="Post title" required />
      <textarea id="content" placeholder="Post content" required></textarea>
      <input id="tags" placeholder="Tags (comma-separated)" />
      <input type="file" id="image" />
      <button type="submit">Submit Post</button>
    </form>
  </div>

  <div id="postList"></div>
</div>

<script>
  const postForm = document.getElementById("postForm");
  const postList = document.getElementById("postList");

  let editingPostId = null;
  let editingImage = "";

  postForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = document.getElementById("title").value.trim();
    const content = document.getElementById("content").value.trim();
    const tags = document.getElementById("tags").value.trim().split(',').map(t => t.trim());
    const file = document.getElementById("image").files[0];

    if (!title || !content) return alert("Title and content required!");

    const submitPost = async (imageData) => {
      const post = {
        title,
        content,
        tags,
        image: imageData || editingImage || "",
        user: "GuestUser",
        likes: 0,
        comments: []
      };

      if (editingPostId) {
        const existing = await fetch(`http://localhost:3000/posts/${editingPostId}`).then(res => res.json());
        post.likes = existing.likes || 0;
        post.comments = existing.comments || [];

        await fetch(`http://localhost:3000/posts/${editingPostId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(post)
        });
        editingPostId = null;
        editingImage = "";
      } else {
        await fetch("http://localhost:3000/posts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(post)
        });
      }

      postForm.reset();
      loadPosts();
    };

    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => submitPost(reader.result);
      reader.readAsDataURL(file);
    } else {
      submitPost("");
    }
  });

  async function loadPosts() {
    const res = await fetch("http://localhost:3000/posts");
    const posts = await res.json();
    postList.innerHTML = "";

    posts.reverse().forEach(p => {
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `
        <h3>${p.title}</h3>
        <p>${p.content}</p>
        ${p.image ? `<img src="${p.image}" alt="Post image" />` : ""}
        <p><strong>Tags:</strong> ${p.tags.join(', ')}</p>
        <p><strong>User:</strong> ${p.user}</p>
        <button onclick="likePost(${p.id}, ${p.likes})">üëç ${p.likes}</button>
        <button onclick="promptComment(${p.id})">üí¨ Comment</button>
        <button onclick="editPost(${p.id})">‚úèÔ∏è Edit</button>
        <button onclick="deletePost(${p.id})">üóëÔ∏è Delete</button>
        <div>
          ${Array.isArray(p.comments) ? p.comments.map(c => `<div class='comment'><strong>@${c.user}:</strong> ${c.text}</div>`).join('') : ''}
        </div>
      `;
      postList.appendChild(div);
    });
  }

  async function likePost(id, currentLikes) {
    await fetch(`http://localhost:3000/posts/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ likes: currentLikes + 1 })
    });
    loadPosts();
  }

  async function promptComment(id) {
    const text = prompt("Your comment:");
    if (!text) return;

    const res = await fetch(`http://localhost:3000/posts/${id}`);
    const post = await res.json();
    post.comments = post.comments || [];
    post.comments.push({ user: "GuestUser", text });

    await fetch(`http://localhost:3000/posts/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ comments: post.comments })
    });

    loadPosts();
  }

  async function deletePost(id) {
    if (confirm("Are you sure you want to delete this post?")) {
      await fetch(`http://localhost:3000/posts/${id}`, { method: "DELETE" });
      loadPosts();
    }
  }

  async function editPost(id) {
    const res = await fetch(`http://localhost:3000/posts/${id}`);
    const post = await res.json();
    document.getElementById("title").value = post.title;
    document.getElementById("content").value = post.content;
    document.getElementById("tags").value = post.tags.join(", ");
    editingPostId = id;
    editingImage = post.image;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  window.onload = loadPosts;
</script>
</body>
</html>
